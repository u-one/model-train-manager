# Phase 2.16: CSVインポート改善・製品未登録時の柔軟な対応

## 概要

製品情報が見つからない場合でも保有車両を登録できるようにし、後から製品情報を作成できる機能を追加します。

## 背景・課題

### 現在の問題
- CSVインポート時、製品が見つからない場合はエラーになり登録できない
- 製品情報を先に登録しないと保有車両を登録できない
- 既存の保有データに対応する製品情報がまだ整備されていない場合、インポートが進まない

### エラーログの例（import_err_log.txt）
```
行 279: 製品が見つかりません (メーカー: KATO, 品番: 10-1603)
行 280: 製品が見つかりません (メーカー: TOMIX, 品番: 98765)
...
```

## 要件

### Phase 2.16.1: CSVインポート改善（優先）

#### 1-1. 製品が見つからない場合の自動対応
- 製品が見つからない場合でも**エラーにせず**独立車両として登録
- メーカー・品番・商品名を独立車両情報に自動保存
- インポート結果に「独立車両として登録」の旨を表示

#### 1-2. インポート結果の詳細化
```
インポート結果：
- 成功: 150件
  - 製品リンク: 120件
  - 独立車両: 30件
- エラー: 5件
```

#### 1-3. CSVフォーマット仕様（変更なし）
既存のCSVフォーマットをそのまま使用：
- メーカー列
- 品番列
- 商品名列
- その他の保有車両情報

### Phase 2.16.2: 製品情報変換機能

#### 2-1. 保有車両詳細画面での変換ボタン
- 独立車両の場合のみ「この情報で製品を作成」ボタンを表示
- 独立車両情報を初期値として製品作成フォームを開く

#### 2-2. 製品作成フォームの改善
- 独立車両情報から自動入力：
  - ブランド（メーカー）
  - 品番
  - 商品名
  - 説明
- 追加情報を入力：
  - 種別（単品/セット/セット単品）
  - 発売年
  - 価格情報
  - 実車情報

#### 2-3. 製品作成後の自動リンク
- 製品作成完了後、自動的に保有車両と製品をリンク
- 独立車両情報は保持（履歴として）

### Phase 2.16.3: 一括製品作成機能

#### 3-1. 独立車両一覧からの一括変換
- 管理画面または保有車両一覧で独立車両をフィルタ
- 選択した独立車両から一括で製品情報を作成
- 同じメーカー・品番の独立車両は1つの製品にまとめる

#### 3-2. セット製品の一括登録（将来拡張）
- セット製品作成時に構成車両も同時登録
- 構成車両の製品情報も一括作成
- Phase 2.17以降で実装予定

## 技術仕様

### データベース設計（変更なし）

既存の `IndependentVehicle` テーブルを活用：

```prisma
model IndependentVehicle {
  id             Int          @id @default(autoincrement())
  ownedVehicleId Int          @unique @map("owned_vehicle_id")
  brand          String?      @db.VarChar(100)    // メーカー
  productCode    String?      @map("product_code") // 品番
  name           String       @db.VarChar(500)     // 商品名
  vehicleType    String?      @map("vehicle_type")
  description    String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  ownedVehicle   OwnedVehicle @relation(fields: [ownedVehicleId], references: [id], onDelete: Cascade)
}
```

### API設計

#### 2.16.1: CSVインポートAPI改善

**エンドポイント**: `POST /api/owned-vehicles/import`

**変更点**:
```typescript
// 製品が見つからない場合の処理
if (!product) {
  // エラーにせず、独立車両として登録
  const ownedVehicle = await prisma.ownedVehicle.create({
    data: {
      userId: user.id,
      managementId: vehicleData.managementId,
      isIndependent: true,
      independentVehicle: {
        create: {
          brand: vehicleData.productBrand,
          productCode: vehicleData.productCode,
          name: vehicleData.productName || '(商品名不明)',
          description: `CSVインポート時に製品が見つからなかったため独立車両として登録`
        }
      },
      // その他の保有車両情報
    }
  })

  importResults.successCount++
  importResults.independentCount++ // 新規追加
  continue
}
```

**レスポンス**:
```json
{
  "message": "インポート処理が完了しました",
  "results": {
    "totalRows": 150,
    "successCount": 145,
    "linkedCount": 120,      // 製品リンク数（新規）
    "independentCount": 25,  // 独立車両数（新規）
    "errorCount": 5,
    "errors": [...]
  }
}
```

#### 2.16.2: 製品情報変換API

**新規エンドポイント**: `POST /api/owned-vehicles/:id/convert-to-product`

**リクエスト**:
```json
{
  "productData": {
    "brand": "KATO",
    "productCode": "10-1603",
    "name": "E233系3000番台 東海道線",
    "type": "SET",
    "releaseYear": 2020,
    "priceExcludingTax": 15000,
    "priceIncludingTax": 16500,
    "description": "..."
  }
}
```

**処理フロー**:
1. 保有車両が独立車両であることを確認
2. 製品情報を作成
3. 保有車両の `productId` を更新
4. `isIndependent` を `false` に変更
5. 独立車両情報は保持（履歴として）

**レスポンス**:
```json
{
  "product": { ... },
  "ownedVehicle": { ... }
}
```

#### 2.16.3: 一括変換API（Phase 2.17で実装）

**新規エンドポイント**: `POST /api/admin/convert-independent-vehicles`

### UI設計

#### 2.16.1: CSVインポート結果画面

```
インポート結果

✅ 成功: 145件
  📦 製品リンク: 120件
  📝 独立車両: 25件

❌ エラー: 5件
  - 行 10: 管理ID "ABC-001" は既に存在します
  - 行 50: 必須項目が不足しています

⚠️ 注意: 25件が独立車両として登録されました。
保有車両一覧から製品情報を作成できます。
```

#### 2.16.2: 保有車両詳細画面（独立車両の場合）

```
┌─────────────────────────────────────┐
│ 保有車両詳細                          │
├─────────────────────────────────────┤
│ 管理ID: MY-001                        │
│                                       │
│ ⚠️ この車両は独立記録されています      │
│                                       │
│ 商品情報（参照なし）                   │
│   メーカー: KATO                      │
│   品番: 10-1603                       │
│   商品名: E233系3000番台 東海道線      │
│                                       │
│ [この情報で製品を作成する]             │
│                                       │
│ 購入情報                              │
│ ...                                   │
└─────────────────────────────────────┘
```

#### 2.16.3: 製品作成フォーム（独立車両から）

```
┌─────────────────────────────────────┐
│ 製品情報作成                          │
├─────────────────────────────────────┤
│ 基本情報（独立車両情報から自動入力）   │
│                                       │
│ メーカー: [KATO          ] *         │
│ 品番:     [10-1603       ] *         │
│ 商品名:   [E233系3000番台...] *      │
│                                       │
│ 追加情報                              │
│                                       │
│ 種別:     [セット▼      ] *          │
│ 発売年:   [2020         ]            │
│ 価格(税抜):[15000        ]            │
│ 価格(税込):[16500        ]            │
│                                       │
│ 説明:                                 │
│ [                        ]            │
│                                       │
│ ☑ 作成後、この保有車両と自動リンク     │
│                                       │
│ [キャンセル]  [製品を作成]            │
└─────────────────────────────────────┘
```

## 実装計画

### Phase 2.16.1: CSVインポート改善（2025年1月24-26日完了） ✅

1. ✅ **仕様書作成** - このドキュメント
2. ✅ **CSVインポートAPI修正**
   - 製品が見つからない場合の処理変更
   - 独立車両として自動登録
   - インポート結果の詳細化
3. ✅ **インポート結果UI改善**
   - 成功件数の内訳表示
   - 独立車両登録の通知
4. ✅ **テスト・確認**
   - import_err_log.txtのデータでテスト
   - エラーが独立車両登録に変わることを確認

### Phase 2.16.2: 製品情報変換機能（2025年1月26日完了） ✅

1. ✅ **保有車両詳細画面改善**
   - 独立車両判定UI追加
   - 「製品を作成」ボタン追加
2. ✅ **製品作成フォーム改善**
   - 独立車両情報からの初期値設定
   - 自動リンクオプション
3. ✅ **変換機能実装**
   - 保有車両詳細画面での独立車両警告表示
   - 製品作成フォームへの遷移（独立車両情報を初期値として設定）
   - 製品作成後の自動リンク
4. ✅ **テスト・確認**

### Phase 2.16.3: 一括変換機能（Phase 3で実装予定）

Phase 2.16.1-2.16.2完了後、Phase 3で実装予定

## テストシナリオ

### 2.16.1: CSVインポート

1. **製品が存在する場合**
   - ✅ 通常通り製品とリンク

2. **製品が存在しない場合**
   - ✅ 独立車両として登録
   - ✅ メーカー・品番・商品名が独立車両情報に保存
   - ✅ エラーにならない

3. **インポート結果表示**
   - ✅ 製品リンク数と独立車両数が表示
   - ✅ 注意メッセージが表示

### 2.16.2: 製品情報変換

1. **変換ボタン表示**
   - ✅ 独立車両の場合のみボタン表示
   - ✅ 製品リンク済みの場合は非表示

2. **製品作成フォーム**
   - ✅ 独立車両情報が初期値として設定
   - ✅ 追加情報を入力して製品作成

3. **自動リンク**
   - ✅ 製品作成後、保有車両が自動的にリンク
   - ✅ 独立車両フラグが更新

## 注意事項

### データ整合性
- 独立車両情報は製品リンク後も削除しない（履歴として保持）
- `isIndependent` フラグで現在の状態を管理

### パフォーマンス
- 大量インポート時のトランザクション管理
- バッチ処理での独立車両作成

### ユーザー体験
- 独立車両の存在を適切に通知
- 製品作成への誘導を自然に

## 関連ドキュメント

- [開発進捗記録](./development-log.md)
- [プロジェクト仕様書](../apps/web-next/docs/specification.md)
- [データベーススキーマ管理](./database-schema-management.md)

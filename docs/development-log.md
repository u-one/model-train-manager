# 鉄道模型車両管理アプリ 開発記録

## プロジェクト概要
Nゲージ鉄道模型の車両情報と保有状況を管理するWebアプリケーション

## 開発進捗

### 完了済み
- [x] プロジェクト要件定義（specification.md）
- [x] ディレクトリ構造設計（rules.md）
- [x] UIワイヤーフレーム作成（5画面）
- [x] CLAUDE.md作成
- [x] 既存データ確認（CSV形式）
- [x] 認証方式をGoogle OAuthに簡素化決定

### Phase 1: プロジェクト基盤構築

#### 1.1 Next.jsプロジェクト作成
- [x] `apps/web-next/` 配下にNext.js 15.5.3プロジェクト作成
- [x] TypeScript + Tailwind CSS + ESLint設定
- [x] フォルダ構造整備
- [x] 基本的な型定義ファイル作成

#### 1.2 開発環境セットアップ
- [x] package.json設定（pnpmワークスペース対応）
- [x] 必要ライブラリ導入：
  - [x] @supabase/supabase-js, prisma
  - [x] next-auth（GoogleProviderのみ）
  - [x] lucide-react, @headlessui/react
  - [x] react-hook-form, zod
- [x] 環境変数設定ファイル作成
- [x] 基本的なlib設定ファイル作成

### Phase 2: 基本機能実装

#### 2.1 認証システム（優先実装）
- [x] NextAuth.js Google OAuth設定
- [x] Google Cloud Console設定（本番環境対応）
- [x] ログイン画面（Googleボタンのみ）
- [x] Vercelデプロイ・認証システム動作確認
- [x] ユーザー自動作成機能（signInコールバック）
- [x] AuthGuard認証保護コンポーネント

#### 2.2 データベース環境構築
- [x] Vercel + Supabase統合環境設定
- [x] Prismaスキーマ作成・マイグレーション実行
- [x] データベース接続確認・テストAPI作成
- [x] 本番環境デプロイ確認

#### 2.3 製品情報機能
- [x] 製品一覧画面（検索・フィルタ・ページネーション）
- [x] 製品詳細画面（基本情報・実車情報・保有状況）
- [x] 製品API実装（CRUD操作）
- [x] Vercelデプロイ確認
- [x] 製品追加フォーム画面
- [x] 製品編集フォーム画面

#### 2.4 保有車両機能
- [x] 保有車両一覧画面（検索・フィルタ・認証制御）
- [x] 保有車両詳細画面（詳細情報・整備記録）
- [x] 保有車両API実装（認証付きCRUD操作）
- [x] ダッシュボード更新・ナビゲーション統合
- [x] Vercelデプロイ・エラー修正確認
- [x] 保有車両追加フォーム画面
- [x] 保有車両編集フォーム画面
- [ ] UI改善（色の調整、入力項目の柔軟性向上）

### Phase 2.5: ID/パスワード認証追加
- [x] NextAuth.js Credentials Provider設定
- [x] ユーザー登録フォーム作成
- [x] パスワードハッシュ化機能（bcrypt）
- [x] ログイン画面の認証選択肢追加
- [x] 既存Google認証との併用対応
- [x] UI改善（入力フィールドコンポーネント化）

### Phase 2.6: セット管理機能実装
- [x] セット構成車両管理機能
- [x] 製品間の親子関係（parentCode）設定
- [x] セット詳細画面での構成車両表示
- [x] セット詳細からのセット単品追加機能
- [x] メーカー情報の自動設定
- [x] SetComponent/ParentSetインターフェース統一化
- [x] Next.js 15 params Promise互換性対応

### Phase 2.7: 認証・権限管理の改善
- [x] 製品追加・編集をログイン時のみに制限
- [x] 保有状況をログインユーザーのみ表示
- [x] 保有車両画面の認証必須化
- [x] 認証状態に応じたUI表示制御

### Phase 2.8: 削除機能の追加
- [x] 製品削除機能（確認ダイアログ付き）
- [x] 保有車両削除機能（確認ダイアログ付き）
- [x] 削除権限チェック（所有者のみ）
- [x] 関連データの整合性チェック

### Phase 2.9: 入力項目の柔軟性向上 → Phase 2.14に統合
- [x] Phase 2.14に移行

### Phase 2.10: UI/UX改善 → Phase 2.14に統合
- [x] ダッシュボードのヘッダ重複問題修正
- [x] セット構成車両の一覧表示オプション
- [x] グリッド/リスト表示の切り替え機能
- [x] 未完了項目はPhase 2.14に移行

### Phase 2.11: CSVインポート機能
- [x] CSVパーサー実装（製品情報・保有車両対応）
- [x] CSVプレビュー機能
- [x] インポートAPI実装（/api/products/import, /api/owned-vehicles/import）
- [x] エラーハンドリングとバリデーション
- [x] 日本語CSVフォーマット対応
- [x] HTML改行タグ変換機能
- [x] 大量データ処理対応（592行のテスト完了）
- [x] インポート進捗表示とUI改善

### Phase 2.12: 管理画面・一括削除機能 ✅
- [x] 管理者認証機能・ミドルウェア実装
- [x] 管理画面レイアウト・ダッシュボード作成
- [x] 製品管理画面・一括削除API実装
- [x] 保有車両管理画面・一括削除API実装
- [x] ユーザー管理機能実装
- [x] **全削除機能の実装** - 安全確認付き一括データ削除
- [x] セキュリティ・監査機能の追加

### Phase 2.13: システム改善・修正 ✅
- [x] ページネーション仕様統一（デフォルト100件）
- [x] 製品インポート一意性修正（メーカー+品番対応）
- [x] ページネーションUI視認性向上（色調整）
- [x] .gitignore整備（Claude関連ファイル除外）
- [x] ドキュメント整理・統一（3主要文書の一貫性確保）

### Phase 2.14: Phase2未完了項目の統合実装
#### 2.14.1 インポート機能改善
- [ ] セットとセット単品の紐づけ処理（インポート後の自動処理）

#### 2.14.2 UI/UX改善
- [ ] レスポンシブデザインの改善（モバイル最適化）
- [ ] 製品一覧・保有車両一覧のデフォルト表示をリスト形式に変更
- [ ] フィルタ機能の強化・改善
- [ ] 製品一覧でセット単品をデフォルト非表示に設定
- [ ] ヘッダに管理者向け管理画面遷移ボタン追加
- [ ] 製品一覧の保有数表示をログインユーザーのみに修正

#### 2.14.3 入力項目の柔軟性向上
- [ ] 管理IDの必須性見直し
- [ ] 発売年：不明・未設定を許容
- [ ] 価格：セット単品時のグレーアウト・無効化（データ的には0でも可）
- [ ] 購入日：不明・未設定を許容
- [ ] 購入情報：必須項目の見直し（わかりにくい必須項目の表示改善）
- [ ] 価格：未入力・不明を許容（任意項目化）
- [ ] バリデーションルールの調整

### Phase 3: 詳細機能
- [ ] 整備記録機能
- [ ] 画像アップロード機能
- [ ] データエクスポート機能

## 技術仕様

### 使用技術
- **フロントエンド**: React (Next.js 15)
- **バックエンド**: Node.js (Next.js API Routes)
- **データベース**: PostgreSQL (Supabase)
- **認証**: NextAuth.js (Google OAuth + ID/パスワード)
- **UI**: Tailwind CSS + Headless UI
- **デプロイ**: Vercel

### データベース設計
主要テーブル:
- products（製品マスタ）
- users（ユーザー）
- owned_vehicles（保有車両）
- maintenance_records（整備記録）

### 既存データ
- `local/車両リスト - 車両商品情報.csv`: 製品マスタデータ
- `local/車両リスト - 保有車両.csv`: 保有車両データ

## 実装順序変更
認証システムを優先実装してデプロイ確認後、DB環境構築を行う方針に変更

## 現在の状況（2025年1月）

### 完成済み機能
- ✅ 認証システム（Google OAuth + ID/パスワード + 自動ユーザー作成）
- ✅ データベース統合（Supabase + Prisma）
- ✅ 製品情報機能（一覧・詳細・検索・フォーム）
- ✅ 保有車両機能（一覧・詳細・認証制御・フォーム）
- ✅ UI改善（入力フィールドコンポーネント化・視認性向上）
- ✅ CSVインポート機能（製品・保有車両データの一括登録）
- ✅ 管理者機能（権限管理・統計表示・一括削除・全削除）
- ✅ Vercel本番環境デプロイ

### Phase 2.5実装完了詳細（2025年1月21日）
#### ID/パスワード認証機能
- ✅ **Prismaスキーマ拡張**: Userテーブルにpasswordフィールド追加
- ✅ **bcryptjs導入**: パスワードハッシュ化（12ラウンド）
- ✅ **NextAuth.js拡張**: CredentialsProvider追加
- ✅ **ユーザー登録API**: `/api/auth/register`実装
- ✅ **ログイン画面改修**: ログイン/登録フォーム切り替え機能
- ✅ **認証連携**: Google OAuth + ID/パスワード併用

#### UI改善（コンポーネント化）
- ✅ **Inputコンポーネント**: React Hook Form対応、エラー表示、必須項目表示
- ✅ **Selectコンポーネント**: options配列対応、統一デザイン
- ✅ **TextAreaコンポーネント**: 一貫したスタイリング
- ✅ **視認性向上**: text-gray-900で入力文字の濃度統一
- ✅ **フォーム適用**: signin、products/edit、owned-vehicles/new

#### テスト用アカウント
- **メールアドレス**: test@uoneweb.net
- **パスワード**: password
- **動作確認済み**: ユーザー登録、ログイン、フォーム操作

### Phase 2.6実装完了詳細（2025年1月21日）
#### セット管理機能
- ✅ **parentCode-based セット管理**: 既存Prismaスキーマを活用
- ✅ **セット構成車両API**: `/api/products/[id]/set-components`実装
- ✅ **親セット取得API**: `/api/products/[id]/parent-sets`実装
- ✅ **セット詳細画面拡張**: 構成車両一覧表示、未登録時のメッセージ
- ✅ **セット単品追加機能**: セット詳細から直接追加、親セット品番自動設定
- ✅ **メーカー自動設定**: URLパラメータ経由でメーカー情報も引き継ぎ
- ✅ **インターフェース統一**: SetComponent/ParentSet削除、Product型に統一
- ✅ **Next.js 15対応**: params Promise互換性、Suspense境界対応

### Phase 2.12実装完了詳細（2025年1月23日）
#### 管理者機能・全削除機能
- ✅ **管理者認証システム**: 環境変数`ADMIN_EMAILS`による権限管理
- ✅ **管理画面レイアウト**: AdminLayoutコンポーネント、サイドバーナビゲーション
- ✅ **ダッシュボード**: 統計情報表示（製品数、保有車両数、ユーザー数）
- ✅ **製品管理画面**: ページネーション、検索、一括選択・削除機能
- ✅ **保有車両管理画面**: ユーザー情報付き一覧、メーカー・品番による製品マッチング
- ✅ **ユーザー管理画面**: 全ユーザー一覧、統計情報表示

#### 全削除機能の安全実装
- ✅ **全削除ボタン**: 製品・保有車両管理画面に専用ボタン追加
- ✅ **安全確認ダイアログ**: 「全削除」文字列入力による確認機能
- ✅ **段階的削除処理**: 関連データ（整備記録、実車情報）も含めた一括削除
- ✅ **専用APIエンドポイント**:
  - `/api/admin/products/delete-all` - 全製品削除
  - `/api/admin/owned-vehicles/delete-all` - 全保有車両削除
- ✅ **権限チェック**: 管理者のみアクセス可能、401/403エラーハンドリング
- ✅ **UI/UX改善**: 視覚的警告（濃い赤色）、進行状況表示、操作無効化

#### セキュリティ強化
- ✅ **多段階確認**: 危険な操作には複数の確認ステップ
- ✅ **管理者警告バナー**: 管理画面での注意喚起表示
- ✅ **操作ログ**: コンソールへの削除操作記録
- ✅ **エラーハンドリング**: 適切なエラーメッセージと復旧案内

### Phase 2.13実装完了詳細（2025年1月23日）
#### システム改善・修正
- ✅ **ページネーション仕様統一**: 全画面でデフォルト100件/ページに統一
  - 製品一覧、保有車両一覧、管理画面でのlimit値を100に修正
  - API側とフロントエンド側の両方で対応
- ✅ **製品インポート一意性修正**: メーカー+品番の組み合わせでの重複チェック
  - brand + product_codeでの一意性チェックに変更
  - エラーメッセージも「メーカー 品番」形式に修正
- ✅ **ページネーションUI視認性向上**: 文字色・背景色の改善
  - text-gray-900 font-medium bg-gray-50で明瞭な表示
  - ボタンのdisabled状態も含めて色調整
- ✅ **.gitignore整備**: Claude関連ファイルの適切な除外
  - .claude/, claude_data/, *.claude等の除外ルール追加
  - 開発環境ファイルの包括的な除外設定
- ✅ **ドキュメント整理・統一**: 3主要文書の一貫性確保
  - CLAUDE.md, specification.md, development-log.mdの情報統一
  - Next.js 15、認証方式（Google OAuth + ID/パスワード）の正確な記載

### 次の実装予定
#### Phase 2.7 - 認証・権限管理の改善
1. **権限制御の強化** - 製品編集、保有車両の認証必須化
2. **UI表示制御** - ログイン状態に応じた機能表示・非表示

#### Phase 2.8 - 削除機能の追加
1. **基本CRUD完成** - 製品・保有車両の削除機能
2. **安全性確保** - 確認ダイアログ、権限チェック

### 実装方針
- **一画面ずつ段階的に実装**
- **react-hook-form + zod によるバリデーション**
- **作成→動作確認→デプロイのサイクル**



# 完了済み機能・修正事項

## 追加・編集画面全般
- ✅ テキストの色が薄くてよく見えない → コンポーネント化で解決
  - ✅ h2やselectアイテム → text-gray-900で統一

## ダッシュボード
- ✅ ヘッダが二重に表示されている
- ✅ グリッドでなく一覧でも表示したい

## 製品一覧
- ✅ 製品追加・編集はログイン時のみ可能とする

## 製品詳細
### セット構成車両
- ✅ グリッドでなく一覧で表示したい

### 保有状況
- ✅ ログイン時のみ表示
- ✅ 表示するのはログインしているユーザーの情報のみ

## 保有車両一覧
- ✅ この画面はログインしたユーザだけが表示可能

### 管理ID
- ✅ 必須項目の見直し

## ページネーション
- ✅ デフォルト100件に変更

## インポート
- ✅ 製品のインポートの一意性はメーカと品番に変更
- ✅ 保有車両と製品の紐づけは、メーカーと品番で紐づけするように変更

## 管理機能
- ✅ 削除機能がないので追加が必要
- ✅ 管理ページとデータの一括削除機能追加

**注意**: 上記メモ項目は適切なPhase（2.9〜2.14、3）に取り込み済みです。




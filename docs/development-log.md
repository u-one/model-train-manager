# 鉄道模型車両管理アプリ 開発記録

## プロジェクト概要
Nゲージ鉄道模型の車両情報と保有状況を管理するWebアプリケーション

## 開発進捗

### 完了済み
- [x] プロジェクト要件定義（specification.md）
- [x] ディレクトリ構造設計（rules.md）
- [x] UIワイヤーフレーム作成（5画面）
- [x] CLAUDE.md作成
- [x] 既存データ確認（CSV形式）
- [x] 認証方式をGoogle OAuthに簡素化決定

### Phase 1: プロジェクト基盤構築

#### 1.1 Next.jsプロジェクト作成
- [x] `apps/web-next/` 配下にNext.js 15.5.3プロジェクト作成
- [x] TypeScript + Tailwind CSS + ESLint設定
- [x] フォルダ構造整備
- [x] 基本的な型定義ファイル作成

#### 1.2 開発環境セットアップ
- [x] package.json設定（pnpmワークスペース対応）
- [x] 必要ライブラリ導入：
  - [x] @supabase/supabase-js, prisma
  - [x] next-auth（GoogleProviderのみ）
  - [x] lucide-react, @headlessui/react
  - [x] react-hook-form, zod
- [x] 環境変数設定ファイル作成
- [x] 基本的なlib設定ファイル作成

### Phase 2: 基本機能実装

#### 2.1 認証システム（優先実装）
- [x] NextAuth.js Google OAuth設定
- [x] Google Cloud Console設定（本番環境対応）
- [x] ログイン画面（Googleボタンのみ）
- [x] Vercelデプロイ・認証システム動作確認
- [x] ユーザー自動作成機能（signInコールバック）
- [x] AuthGuard認証保護コンポーネント

#### 2.2 データベース環境構築
- [x] Vercel + Supabase統合環境設定
- [x] Prismaスキーマ作成・マイグレーション実行
- [x] データベース接続確認・テストAPI作成
- [x] 本番環境デプロイ確認

#### 2.3 製品情報機能
- [x] 製品一覧画面（検索・フィルタ・ページネーション）
- [x] 製品詳細画面（基本情報・実車情報・保有状況）
- [x] 製品API実装（CRUD操作）
- [x] Vercelデプロイ確認
- [x] 製品追加フォーム画面
- [x] 製品編集フォーム画面

#### 2.4 保有車両機能
- [x] 保有車両一覧画面（検索・フィルタ・認証制御）
- [x] 保有車両詳細画面（詳細情報・整備記録）
- [x] 保有車両API実装（認証付きCRUD操作）
- [x] ダッシュボード更新・ナビゲーション統合
- [x] Vercelデプロイ・エラー修正確認
- [x] 保有車両追加フォーム画面
- [x] 保有車両編集フォーム画面
- [ ] UI改善（色の調整、入力項目の柔軟性向上）

### Phase 2.5: ID/パスワード認証追加
- [x] NextAuth.js Credentials Provider設定
- [x] ユーザー登録フォーム作成
- [x] パスワードハッシュ化機能（bcrypt）
- [x] ログイン画面の認証選択肢追加
- [x] 既存Google認証との併用対応
- [x] UI改善（入力フィールドコンポーネント化）

### Phase 2.6: セット管理機能実装
- [x] セット構成車両管理機能
- [x] 製品間の親子関係（parentCode）設定
- [x] セット詳細画面での構成車両表示
- [x] セット詳細からのセット単品追加機能
- [x] メーカー情報の自動設定
- [x] SetComponent/ParentSetインターフェース統一化
- [x] Next.js 15 params Promise互換性対応

### Phase 2.7: 認証・権限管理の改善
- [x] 製品追加・編集をログイン時のみに制限
- [x] 保有状況をログインユーザーのみ表示
- [x] 保有車両画面の認証必須化
- [x] 認証状態に応じたUI表示制御

### Phase 2.8: 削除機能の追加
- [x] 製品削除機能（確認ダイアログ付き）
- [x] 保有車両削除機能（確認ダイアログ付き）
- [x] 削除権限チェック（所有者のみ）
- [x] 関連データの整合性チェック

### Phase 2.9: 入力項目の柔軟性向上
- [ ] 発売年：不明・未設定を許容
- [ ] 価格：セット単品時のグレーアウト・無効化
- [ ] 購入日：不明・未設定を許容
- [ ] 購入情報：必須項目の見直し
- [ ] バリデーションルールの調整

### Phase 2.10: UI/UX改善
- [x] ダッシュボードのヘッダ重複問題修正
- [x] セット構成車両の一覧表示オプション
- [x] グリッド/リスト表示の切り替え機能
- [ ] レスポンシブデザインの改善

### Phase 3: 詳細機能
- [ ] 整備記録機能
- [ ] 画像アップロード機能
- [ ] データエクスポート機能
- [ ] CSVインポート機能

## 技術仕様

### 使用技術
- **フロントエンド**: React (Next.js 14)
- **バックエンド**: Node.js (Next.js API Routes)
- **データベース**: PostgreSQL (Supabase)
- **認証**: NextAuth.js (Google OAuth + ID/パスワード)
- **UI**: Tailwind CSS + Headless UI
- **デプロイ**: Vercel

### データベース設計
主要テーブル:
- products（製品マスタ）
- users（ユーザー）
- owned_vehicles（保有車両）
- maintenance_records（整備記録）

### 既存データ
- `local/車両リスト - 車両商品情報.csv`: 製品マスタデータ
- `local/車両リスト - 保有車両.csv`: 保有車両データ

## 実装順序変更
認証システムを優先実装してデプロイ確認後、DB環境構築を行う方針に変更

## 現在の状況（2025年1月）

### 完成済み機能
- ✅ 認証システム（Google OAuth + ID/パスワード + 自動ユーザー作成）
- ✅ データベース統合（Supabase + Prisma）
- ✅ 製品情報機能（一覧・詳細・検索・フォーム）
- ✅ 保有車両機能（一覧・詳細・認証制御・フォーム）
- ✅ UI改善（入力フィールドコンポーネント化・視認性向上）
- ✅ Vercel本番環境デプロイ

### Phase 2.5実装完了詳細（2025年1月21日）
#### ID/パスワード認証機能
- ✅ **Prismaスキーマ拡張**: Userテーブルにpasswordフィールド追加
- ✅ **bcryptjs導入**: パスワードハッシュ化（12ラウンド）
- ✅ **NextAuth.js拡張**: CredentialsProvider追加
- ✅ **ユーザー登録API**: `/api/auth/register`実装
- ✅ **ログイン画面改修**: ログイン/登録フォーム切り替え機能
- ✅ **認証連携**: Google OAuth + ID/パスワード併用

#### UI改善（コンポーネント化）
- ✅ **Inputコンポーネント**: React Hook Form対応、エラー表示、必須項目表示
- ✅ **Selectコンポーネント**: options配列対応、統一デザイン
- ✅ **TextAreaコンポーネント**: 一貫したスタイリング
- ✅ **視認性向上**: text-gray-900で入力文字の濃度統一
- ✅ **フォーム適用**: signin、products/edit、owned-vehicles/new

#### テスト用アカウント
- **メールアドレス**: test@uoneweb.net
- **パスワード**: password
- **動作確認済み**: ユーザー登録、ログイン、フォーム操作

### Phase 2.6実装完了詳細（2025年1月21日）
#### セット管理機能
- ✅ **parentCode-based セット管理**: 既存Prismaスキーマを活用
- ✅ **セット構成車両API**: `/api/products/[id]/set-components`実装
- ✅ **親セット取得API**: `/api/products/[id]/parent-sets`実装
- ✅ **セット詳細画面拡張**: 構成車両一覧表示、未登録時のメッセージ
- ✅ **セット単品追加機能**: セット詳細から直接追加、親セット品番自動設定
- ✅ **メーカー自動設定**: URLパラメータ経由でメーカー情報も引き継ぎ
- ✅ **インターフェース統一**: SetComponent/ParentSet削除、Product型に統一
- ✅ **Next.js 15対応**: params Promise互換性、Suspense境界対応

### 次の実装予定
#### Phase 2.7 - 認証・権限管理の改善
1. **権限制御の強化** - 製品編集、保有車両の認証必須化
2. **UI表示制御** - ログイン状態に応じた機能表示・非表示

#### Phase 2.8 - 削除機能の追加
1. **基本CRUD完成** - 製品・保有車両の削除機能
2. **安全性確保** - 確認ダイアログ、権限チェック

### 実装方針
- **一画面ずつ段階的に実装**
- **react-hook-form + zod によるバリデーション**
- **作成→動作確認→デプロイのサイクル**



# メモ
## 削除機能
- 削除機能がないので追加が必要
## 追加・編集画面全般
- ✅ テキストの色が薄くてよく見えない → コンポーネント化で解決
  - ✅ h2やselectアイテム → text-gray-900で統一

## ダッシュボード
- ヘッダが二重に表示されている
- グリッドでなく一覧でも表示したい

## 製品一覧
- 製品追加・編集はログイン時のみ可能とする
- 保有数が表示されているが、全ユーザの保有数になっている

## 製品詳細
### 発売年
- 不明な場合があるので任意または不明を指定できるようにしたい
### 価格
- セット単品の場合は価格はないので、価格も入力不要でグレーアウト・無効化にしたい。データ的には0でも良いかもしれないが。

### セット構成車両
- グリッドでなく一覧で表示したい

### 保有状況
- ログイン時のみ表示
- 表示するのはログインしているユーザーの情報のみ

## 保有車両
- この画面はログインしたユーザだけが表示可能

### 管理ID
- 必須項目の見直し

### 購入日
- 不明なども入れたい
- 未設定も許容したい

### その他
- 実際には購入情報も必須っぽい動作になっているが、何も表示されないのでわかりにくい
- 価格なども未入力か不明を許容したい


- 管理ページとデータの一括削除機能追加
- 製品のインポート後、セットとセット単品の紐づけ処理を追加
- 保有車両と製品の紐づけは、メーカーと品番で紐づけするように変更